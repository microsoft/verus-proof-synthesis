*******************************************************************************
**********Tasks that require spec changes*************

Item 1 and 2 have been confirmed by J.Lorch and C. Hawblitzel, and hence corresponding tasks have been changed.

TODO: Item 3 requires atmosphere authors' confirmation.

1. A set in lemma_u.rs, among which 4 are in the benchmark set _assumed_lemma_seq... (the remaining one does not requirep roof annotations)
I have changed the spec in unverified set.

2. A set of 6 fold-related lemmas in kernel::spec_impl1__fold...
The function pre-condition requires an addition ```self.container_dom().finite(),```
They have all been changed in the unverified task set.

Sonnet 4.5 added this pre-condition to these three tasks while finishging the proof.
*** _assumed_kernel__spec__impl1__fold_change_ioid_lemma: CHEAT (maybe)
*** _assumed_kernel__spec__impl1__fold_change_mem_4k_lemma: CHEAT (maybe)
*** _assumed_kernel__spec__impl1__fold_mem_4k_lemma: CHEAT (maybe)

Sonnet 4.5 failed these three tasks, but after manual examination, their pre-condition is missing the same finite() constraint.
_assumed_kernel__spec__impl1__fold_change_pcid_lemma
_assumed_kernel__spec__impl1__fold_ioid_lemma
_assumed_kernel__spec__impl1__fold_pcid_lemma

3. A number of executable functions that had no spec (they were tagged as external_body)
*** _assumed_kernel__create_and_share_pages__impl0__create_entry_and_share_to_iommu_table: CHEAT (maybe)
*** _assumed_kernel__create_and_share_pages__impl0__range_create_and_share_mapping_to_iommu_table: CHEAT (maybe)
*** _assumed_kernel__create_and_share_pages__impl0__share_mapping_to_iommu_table: CHEAT (maybe)

There might be more there. The above three were the ones that LLM was able to prove after its propose spec change.

*******************************************************************************
*********The list of _assumed_ benchmarks comes from several sources***********
1. some of them had assume or admit in the original proof
2. Some had assert(false)
3. Some are tagged as external_body 
Only a small portion of external_body functions are included in our benchmarks,
as some of them might indeed should be external_body.
The ones included here are the ones that we think should be proved, 
such as (1) the ones, the authors had comments about TODO, how to prove, etc.
(2) all the functions in lemma_u.rs

4. The original proof still had verification error.
There are different sources of this:
(1) the original project when sent to us has one function that is not yet verified.
(2) after we fixed the pre-conditions of functions in lemma_u.rs, about 7 more functions now cannot be verified.
(3) a couple of functions' verification times out, and the behavior may not be the same in the original project.
In the original project, there were a number of time out as well, until I give rlimit(500) to those functions
(then only one times out). Now, I use rlimit(200), and some function's time may be different from when it
is in the original project.

Note: the following is NOT a complete list

allocator__page_allocator_spec_impl__impl1__len_lemma_allocated_2m.rs:        assume(all_page_ptrs.finite());
allocator__page_allocator_spec_impl__impl1__len_lemma_allocated_4k.rs:        assume(all_page_ptrs.len() == NUM_PAGES);  // this should be inferred smh by verus...
allocator__page_allocator_spec_impl__impl1__len_lemma_mapped_2m.rs:        assume(all_page_ptrs.len() == NUM_PAGES);  // this should be inferred smh by verus...
allocator__page_allocator_spec_impl__impl1__len_lemma_mapped_4k.rs:        assume(all_page_ptrs.len() == NUM_PAGES);  // this should be inferred smh by verus...
allocator__page_allocator_spec_impl__impl2__split_2m_to_4k.rs:            assume( forall|i: usize, j:usize|
array_set__impl0__insert.rs:            assume(all_value_set.len() == N); // this should be inferred smh by verus...
memory_manager__spec_impl__impl0__free_page_table.rs:        assume(self.free_pcids.len() < PCID_MAX);
kernel/create_and_share_pages.rs share_mapping_to_iommu_table assume(false)
kernel__create_and_share_pages__impl0__create_entry_and_share_to_iommu_table
kernel/range_create_and_share_mapping_to_iommu_table(
kernel__create_and_share_pages__impl0__create_entry_and_share_to_iommu_table.rs: assume(false)
kernel__create_and_share_pages__impl0__range_create_and_share_mapping_to_iommu_table.rs: assume(false)
kernel__create_and_share_pages__impl0__share_mapping_to_iommu_table.rs: assume (false)
kernel__kernel_kill_proc__impl0__kernel_kill_proc_recursive_non_root.rs: assume many assumes
kernel__spec__impl1__fold_change_ioid_lemma.rs   :     // @TODO: prove this \n #[verifier(external_body)]
kernel__spec__impl1__fold_change_pcid_lemma.rs  : 	// @TODO: prove this \n #[verifier(external_body)]
kernel__spec__impl1__fold_mem_4k_lemma.rs: 	// @TODO: prove this \n #[verifier(external_body)]
kernel__spec__impl1__fold_change_mem_4k_lemma.rs  : 	// @TODO: prove this \n #[verifier(external_body)]
kernel__spec__impl1__fold_ioid_lemma.rs         : 	// @TODO: prove this \n #[verifier(external_body)]
kernel__spec__impl1__fold_pcid_lemma.rs: 	// @TODO: prove this \n #[verifier(external_body)]
process_manager__spec_proof__impl2_proc_owned_threads_disjoint_inv(&self) : admit() //TODO
process_manager__impl_kill_container__impl0__kill_container_none_root: assume
process_manager__impl_kill_proc__impl0__kill_process_root.rs: assume
process_manager__impl_new_container__impl0__new_container_with_endpoint: assume. but the assume is not needed!!! TODO: I should remind the authors.
process_manager__spec_proof__impl2__wf_imply_container_no_proc_to_no_thread.rs: assume

==oringal project has error here ...========
pagetable_impl_base.rs::unmap_4k_page(
pagetable__pagetable_spec__impl0__new.

syscall_send_endpoint.rs syscall_send_endponit(  (I belivethis had error even before lemma fixed)
process_manager__impl_base__impl0__pop_scheduler_for_idle_cpu.rs error: assertion failed assert(self.threads_container_wf());
process_manager__impl_base__impl0__schedule_running_thread.rs error: assertion failed assert(self.threads_container_wf());
process_manager__impl_kill_thread__impl0__kill_blocked_thread.rs: assertion failed

process_manager__impl_new_thread__impl0__new_thread_with_endpoint.rs: assertion failed



*******************************************************************************
***********Original project had proof annotation, but...=========
(this is less important)
allocator__page_allocator_spec_impl__impl2__remove_io_mapping_4k.rs: no proof needed
allocator__page_allocator_spec_impl__impl2__remove_mapping_4k.rs: no proof needed
memory_manager__spec_impl__impl0__get_iommu_table_l4_entry.rs: no proof needed
memory_manager__spec_impl__impl0__get_pagetable_l4_entry.rs
memory_manager__spec_impl__impl0__iommu_table_map_4k_page.rs
memory_manager__spec_impl__impl0__pagetable_map_4k_page.rs

array_test.rs: test purpose; nothing to really prove
array_vec__test.rs: test purpose; nothing to really prove



====Whole project verification error log after lemma is fixed====
error: postcondition not satisfied
   --> kernel/syscall_send_endpoint.rs:251:13
    |
251 | /             syscall_send_endpoint_spec(
252 | |                 *old(self),
253 | |                 *self,
254 | |                 sender_thread_ptr,
...   |
257 | |                 ret,
258 | |             ),
    | |_____________^ failed this postcondition
...
341 |               return SyscallReturnStruct::NoSwitchNew(RetValueType::Error);
    |               ------------------------------------------------------------ at this exit

error: precondition not satisfied
    --> kernel/syscall_send_endpoint.rs:358:9
     |
358  | /         self.proc_man.pass_endpoint(
359  | |             sender_thread_ptr,
360  | |             sender_endpoint_payload,
361  | |             receiver_thread_ptr,
362  | |             receiver_endpoint_payload,
363  | |         );
     | |_________^
     |
    ::: process_manager/impl_base.rs:1553:13
     |
1553 | / ...   (
1554 | | ...       old(self).get_endpoint(old(self).get_thread(src_thread_ptr).endpoint_descriptors@[src_...
1555 | | ...           == old(self).get_thread(dst_thread_ptr).owning_container
1556 | | ...       ||
...    |
1560 | | ...   ),
     | |_______- failed precondition

note: function body check: not all errors may have been reported; rerun with a higher value for --multiple-errors to find other potential errors in this function
   --> kernel/syscall_send_endpoint.rs:238:5
    |
238 | /     pub fn syscall_send_endpoint(
239 | |         &mut self,
240 | |         sender_thread_ptr: ThreadPtr,
241 | |         blocking_endpoint_index: EndpointIdx,
242 | |         sender_endpoint_payload: EndpointIdx,
243 | |     ) -> (ret: SyscallReturnStruct)
    | |__________________________________^

note: recommendation not met
  --> pagetable/pagetable_spec.rs:74:24
   |
74 |                     == page_map_perm.value()[i],
   |                        ^^^^^^^^^^^^^^^^^^^^^^^^
   |
  ::: pagetable/pagemap.rs:74:13
   |
74 |             0 <= index < 512,
   |             ---------------- recommendation not met

error: assertion failed
  --> pagetable/pagetable_spec.rs:88:16
   |
88 |           assert(forall|i: usize|
   |  ________________^
89 | |             #![trigger page_map_perm.value()[i].is_empty()]
90 | |             #![trigger page_map_perm.value()[i].perm.present]
91 | |             mem_end_l4_index <= i < 512 ==> page_map_perm.value()[i].is_empty()
92 | |                 && page_map_perm.value()[i].perm.present == false
93 | |                 && page_map_perm.value()[i].perm.write == false
94 | |                 && page_map_perm.value()[i].perm.execute_disable == false);
   | |_________________________________________________________________________^ assertion failed

error: assertion failed
   --> pagetable/pagetable_impl_base.rs:926:16
    |
926 |         assert(self.tlb_submap_of_mapping()) by {
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ assertion failed

error: function body check: Resource limit (rlimit) exceeded; consider rerunning with --profile for more details
    --> pagetable/pagetable_impl_base.rs:1048:5
     |
1048 | /     pub fn map_2m_page(
1049 | |         &mut self,
1050 | |         target_l4i: L4Index,
1051 | |         target_l3i: L3Index,
...    |
1054 | |         target_entry: &MapEntry,
1055 | |     )
     | |_____^

error: assertion failed
   --> process_manager/impl_base.rs:483:16
    |
483 |         assert(self.threads_container_wf());
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^ assertion failed

note: recommendation not met
   --> process_manager/impl_base.rs:259:17
    |
259 | /                 old(self).get_thread(
260 | |                     old(self).get_cpu(cpu_id).current_thread.unwrap(),
261 | |                 ).owning_container,
    | |_________________^
    |
   ::: process_manager/spec_proof.rs:144:13
    |
144 |               self.thread_dom().contains(thread_ptr),
    |               -------------------------------------- recommendation not met

error: assertion failed
    --> process_manager/impl_base.rs:2142:16
     |
2142 |         assert(self.threads_container_wf());
     |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^ assertion failed

note: recommendation not met
    --> process_manager/impl_base.rs:1973:13
     |
1973 |             old(self).cpu_list@[cpu_id as int].current_thread.is_None(),
     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     |
    ::: /home/shanlu/programs/verus-202509/verus/source/target-verus/release/vstd/seq.rs:62:13
     |
62   |             0 <= i < self.len(),
     |             ------------------- recommendation not met

note: recommendation not met
    --> process_manager/impl_base.rs:1975:17
     |
1975 |                 old(self).cpu_list@[cpu_id as int].owning_container,
     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     |
    ::: /home/shanlu/programs/verus-202509/verus/source/target-verus/release/vstd/seq.rs:62:13
     |
62   |             0 <= i < self.len(),
     |             ------------------- recommendation not met

note: recommendation not met
    --> process_manager/impl_base.rs:1972:13
     |
1972 |             old(self).cpu_list@[cpu_id as int].active == true,
     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     |
    ::: /home/shanlu/programs/verus-202509/verus/source/target-verus/release/vstd/seq.rs:62:13
     |
62   |             0 <= i < self.len(),
     |             ------------------- recommendation not met

error: assertion failed
   --> process_manager/impl_kill_thread.rs:422:20
    |
422 |             assert(self.threads_container_wf()) by {
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^ assertion failed

Some checks are taking longer than 2s (diagnostics for these may be reported out of order)
• kernel/kernel_kill_proc.rs:16:5: 16:73 has finished in 5s
  ⌝ function body check for lib::kernel::spec::Kernel::helper_kernel_kill_proc_non_root
• kernel/syscall_mmap.rs:136:5: 137:28 has finished in 3s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_mmap
• kernel/syscall_new_endpoint.rs:108:5: 112:35 has finished in 2s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_new_endpoint
• kernel/syscall_new_container.rs:202:5: 209:35 has finished in 14s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_new_container_with_endpoint
• kernel/mem_util.rs:46:5: 46:94 has finished in 17s
  ⌝ function body check for lib::kernel::spec::Kernel::create_entry
• kernel/syscall_new_proc.rs:186:5: 192:35 has finished in 12s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_new_proc_with_endpoint
• kernel/create_and_share_pages.rs:121:5: 129:6 has finished in 2s
  ⌝ function body check for lib::kernel::spec::Kernel::share_mapping
• kernel/syscall_new_proc_with_iommu.rs:23:5: 29:35 has finished in 9s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_new_proc_with_endpoint_iommu
• kernel/create_and_map_pages.rs:113:5: 118:24 has finished in 3s
  ⌝ function body check for lib::kernel::spec::Kernel::alloc_and_map
• kernel/syscall_new_thread_with_endpoint.rs:136:5: 141:35 has finished in 2s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_new_thread_with_endpoint
• kernel/kernel_kill_thread.rs:9:5: 9:64 has finished in 5s
  ⌝ function body check for lib::kernel::spec::Kernel::kernel_kill_thread
• kernel/syscall_receive_pages.rs:254:5: 259:35 has finished in 18s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_receive_pages
• kernel/syscall_receive_endpoint.rs:231:5: 236:35 has finished in 19s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_receive_endpoint
• kernel/create_and_share_pages.rs:630:9: 789:10 has finished in 2s
  ⌝ while loop for lib::kernel::spec::Kernel::range_create_and_share_mapping
• kernel/syscall_send_pages.rs:255:5: 260:35 has finished in 14s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_send_pages
• kernel/syscall_send_empty.rs:94:5: 99:35 has finished in 2s
  ⌝ function body check for lib::kernel::spec::Kernel::syscall_send_empty_block
• kernel/kernel_kill_proc.rs:97:5: 97:69 has finished in 6s
  ⌝ function body check for lib::kernel::spec::Kernel::helper_kernel_kill_proc_rootnote: automatically chose triggers for this expression:
  --> lemma/lemma_u.rs:57:5
   |
57 |     assert forall|s: Seq<A>, v: A| s.push(v).contains(v) by {
   |     ^^^^^^

note:   trigger 1 of 1:
  --> lemma/lemma_u.rs:57:36
   |
57 |     assert forall|s: Seq<A>, v: A| s.push(v).contains(v) by {
   |                                    ^^^^^^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:220:5
    |
220 |     assert forall|s: Seq<A>| s.len() > 0 implies s.contains(s[0]) by {
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:220:30
    |
220 |     assert forall|s: Seq<A>| s.len() > 0 implies s.contains(s[0]) by {
    |                              ^^^^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:224:5
    |
224 |     assert forall|s: Seq<A>| s.len() > 0 && s.no_duplicates() implies !s.skip(1).contains(s[0]) by {
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:224:45
    |
224 |     assert forall|s: Seq<A>| s.len() > 0 && s.no_duplicates() implies !s.skip(1).contains(s[0]) by {
    |                                             ^^^^^^^^^^^^^^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:102:5
    |
102 |     assert forall|s: Seq<A>, v: A| s.len() != 0 && s.no_duplicates() && s.contains(v) && s[0] != v
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:102:73
    |
102 |     assert forall|s: Seq<A>, v: A| s.len() != 0 && s.no_duplicates() && s.contains(v) && s[0] != v
    |                                                                         ^^^^^^^^^^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:514:5
    |
514 |     assert forall|s: Seq<A>, v: A| s.no_duplicates() implies s.remove_value(v).contains(v) == false...
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:514:62
    |
514 |     assert forall|s: Seq<A>, v: A| s.no_duplicates() implies s.remove_value(v).contains(v) == false...
    |                                                              ^^^^^^^^^^^^^^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:441:5
    |
441 |     assert forall|s: Seq<A>, v: A| s.no_duplicates() && s.contains(v) == false
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:441:57
    |
441 |     assert forall|s: Seq<A>, v: A| s.no_duplicates() && s.contains(v) == false
    |                                                         ^^^^^^^^^^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:373:5
    |
373 |     assert forall|s: Seq<A>, v: A, i: int|
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:374:29
    |
374 |         0 <= i < s.len() && s.contains(v) && s[i] != v && s.no_duplicates() && s.index_of(v) < i
    |                             ^^^^^^^^^^^^^    ^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:408:5
    |
408 |     assert forall|s: Seq<A>, v: A, i: int|
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:409:29
    |
409 |         0 <= i < s.len() && s.contains(v) && s[i] != v && s.no_duplicates() && s.index_of(v) > i
    |                             ^^^^^^^^^^^^^    ^^^^

note: automatically chose triggers for this expression:
   --> lemma/lemma_u.rs:546:5
    |
546 |     assert forall|s: Seq<A>, i: int| 0 <= i < s.len() && s.no_duplicates()
    |     ^^^^^^

note:   trigger 1 of 1:
   --> lemma/lemma_u.rs:547:28
    |
547 |         implies s.index_of(s[i]) == i by {
    |                            ^^^^

note: Verus printed one or more automatically chosen quantifier triggers
      because it had low confidence in the chosen triggers.
      To suppress these messages, do one of the following:
        (1) manually annotate a single desired trigger using #[trigger]
            (example: forall|i: int, j: int| f(i) && #[trigger] g(i) && #[trigger] h(j)),
        (2) manually annotate multiple desired triggers using #![trigger ...]
            (example: forall|i: int| #![trigger f(i)] #![trigger g(i)] f(i) && g(i)),
        (3) accept the automatically chosen trigger using #![auto]
            (example: forall|i: int, j: int| #![auto] f(i) && g(i) && h(j))
        (4) use the --triggers-mode silent command-line option to suppress all printing of triggers.
      (Note: triggers are used by the underlying SMT theorem prover to instantiate quantifiers;
      the theorem prover instantiates a quantifier whenever some expression matches the
      pattern specified by one of the quantifier's triggers.)
   --> lemma/lemma_u.rs:546:5
    |
546 |     assert forall|s: Seq<A>, i: int| 0 <= i < s.len() && s.no_duplicates()
    |     ^^^^^^

verification results:: 521 verified, 7 errors
error: aborting due to 8 previous errors; 3 warnings emitted
